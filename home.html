<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css"> 
  <link rel="icon" href="bread.ico" type="image/x-icon">
  <title>Word of the Day</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    .word { font-size: 2rem; font-weight: bold; margin: 20px 0; }
    .definition { font-size: 1.2rem; color: #444; margin-bottom: 30px; }
    .response-box { margin: 20px auto; width: 80%; max-width: 600px; }
    textarea { width: 100%; height: 100px; padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px; }
    select, button { margin-top: 10px; padding: 8px 12px; font-size: 1rem; }
    .history { margin-top: 40px; text-align: left; max-width: 700px; margin-left: auto; margin-right: auto; }
    .entry { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .entry strong { display: block; margin-bottom: 5px; }

    #imagePreview img, .commentImagePreview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      margin: 4px;
      border: 1px solid #ccc;
    }

    /* Other existing styles unchanged */
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>

<body>
  <h1>Word of the Day</h1>

  <div class="word" id="wordBox">Loading...</div>
  <div class="definition" id="definition"></div>
  <button onclick="getRandomWord()">Refresh Word</button>

  <div class="response-box">
    <label for="nameSelect"><strong>Who are you?</strong></label>
    <select id="nameSelect">
      <option value="Selene">Selene</option>
      <option value="Angelica">AngÃ©lica</option>
    </select>

    <textarea id="responseInput" placeholder="Write your thoughts..."></textarea>
    <br>

    <input type="file" id="imageUpload" multiple accept="image/*" onchange="previewImages(event)">
    <div id="imagePreview"></div>

    <button id="submitBtn">Submit</button>
  </div>

  <div class="history">
    <h2>Response History</h2>
    <div id="historyList"></div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCSIO3qjNhXbnwq9D_-L4jT8p1t1izqf9Y",
  authDomain: "nemoydemo.firebaseapp.com",
  projectId: "nemoydemo",
  storageBucket: "nemoydemo.firebasestorage.app",
  messagingSenderId: "396078882117",
  appId: "1:396078882117:web:82f885e49eb6d3c556722c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentWord = "";
let selectedImages = [];

// âœ… Preview & store base64 images for responses
function previewImages(event) {
  const files = event.target.files;
  const preview = document.getElementById("imagePreview");
  preview.innerHTML = "";
  selectedImages = [];

  for (const file of files) {
    if (file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement("img");
        img.src = e.target.result;
        preview.appendChild(img);
        selectedImages.push(e.target.result);
      };
      reader.readAsDataURL(file);
    }
  }
}

// âœ… Get random word + definition
async function getRandomWord() {
  try {
    const res = await fetch("https://random-word-api.vercel.app/api?count=1");
    const data = await res.json();
    currentWord = data[0];
    document.getElementById("wordBox").textContent = currentWord;
    fetchDefinition(currentWord);
  } catch {
    document.getElementById("wordBox").textContent = "Error fetching word ðŸ˜¢";
  }
}

async function fetchDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    const data = await res.json();
    document.getElementById("definition").textContent = data[0]?.meanings[0]?.definitions[0]?.definition || "No definition available.";
  } catch {
    document.getElementById("definition").textContent = "No definition found ðŸ˜¢";
  }
}

// âœ… Submit response (with persistent image saving)
document.getElementById("submitBtn").addEventListener("click", async () => {
  const name = document.getElementById("nameSelect").value;
  const text = document.getElementById("responseInput").value.trim();

  if (!text && selectedImages.length === 0) {
    alert("Write something or upload an image!");
    return;
  }

  await db.collection("responses").add({
    word: currentWord,
    name,
    text: text || null,
    images: selectedImages || [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("responseInput").value = "";
  document.getElementById("imagePreview").innerHTML = "";
  selectedImages = [];

  alert("Response submitted!");
});

// âœ… Comment image storage
const commentImagesMap = new Map();

function previewCommentImages(event, inputElement) {
  const files = event.target.files;
  const previewDiv = inputElement.nextElementSibling;
  previewDiv.innerHTML = "";
  const imageList = [];

  for (const file of files) {
    if (file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement("img");
        img.src = e.target.result;
        previewDiv.appendChild(img);
        imageList.push(e.target.result);
      };
      reader.readAsDataURL(file);
    }
  }
  commentImagesMap.set(inputElement, imageList);
}

// âœ… Add comment box for each entry
function addCommentBox(docId, entryDiv) {
  const wrapper = document.createElement("div");
  wrapper.style.marginTop = "10px";
  wrapper.style.paddingLeft = "10px";
  wrapper.style.borderLeft = "2px solid #25334d";

  const commentsDiv = document.createElement("div");
  commentsDiv.id = `comments-${docId}`;
  wrapper.appendChild(commentsDiv);

  const commentBox = document.createElement("div");
  commentBox.innerHTML = `
    <textarea id="commentInput-${docId}" placeholder="Write a comment..." 
      style="width:90%;height:40px;font-size:0.9rem;padding:4px;margin-top:6px;"></textarea>
    <br>
    <input type="file" class="commentImageUpload" multiple accept="image/*" onchange="previewCommentImages(event, this)">
    <div class="commentImagePreview"></div>
    <button onclick="submitComment('${docId}', this)" style="margin-top:6px;padding:4px 8px;">Comment</button>
  `;
  wrapper.appendChild(commentBox);
  entryDiv.appendChild(wrapper);

  db.collection("responses").doc(docId).collection("comments").orderBy("timestamp").onSnapshot(snapshot => {
    commentsDiv.innerHTML = "";
    snapshot.forEach(c => {
      const data = c.data();
      const p = document.createElement("p");
      p.innerHTML = `<em>${data.name}:</em> ${data.text}`;
      commentsDiv.appendChild(p);

      if (data.images?.length) {
        const imgDiv = document.createElement("div");
        data.images.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.style.width = "80px";
          img.style.margin = "3px";
          imgDiv.appendChild(img);
        });
        commentsDiv.appendChild(imgDiv);
      }
    });
  });
}

// âœ… Submit comment
async function submitComment(docId, btn) {
  const input = document.getElementById(`commentInput-${docId}`);
  const text = input.value.trim();
  if (!text && !commentImagesMap.get(btn.previousElementSibling.previousElementSibling)?.length) return;

  const uploadInput = btn.previousElementSibling.previousElementSibling;
  const images = commentImagesMap.get(uploadInput) || [];

  await db.collection("responses").doc(docId).collection("comments").add({
    name: document.getElementById("nameSelect").value,
    text,
    images,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  input.value = "";
  uploadInput.value = "";
  uploadInput.nextElementSibling.innerHTML = "";
}

// âœ… Load responses + comments
function loadHistory() {
  db.collection("responses").orderBy("timestamp", "desc").onSnapshot(snapshot => {
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = "";

    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "entry";

      let html = `<strong>${data.word} â€“ ${data.name}</strong>`;
      if (data.text) html += `<div>${data.text}</div>`;
      if (data.images?.length) {
        html += `<div>${data.images.map(src => `<img src="${src}" style="width:100px;margin:4px;border-radius:6px;">`).join("")}</div>`;
      }

      div.innerHTML = html;
      historyList.appendChild(div);
      addCommentBox(doc.id, div);
    });
  });
}

getRandomWord();
loadHistory();
</script>
</body>
</html>
